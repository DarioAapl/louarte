<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Admin Panel</title>
  <link rel="icon" type="image/png" href="lucianino-memoji.png" />
  <link rel="stylesheet" href="admin.css">
</head>
<body>

<div class="container">
  <div class="text-content" style="max-width:1000px;width:100%;">
    <div class="fade-in">Admin Panel</div>
    <div class="under-construction">Add / Edit / Delete / Reorder</div>

    <br>

    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
      <button class="tabBtn" data-tab="artworks">Arte</button>
      <button class="tabBtn" data-tab="photos">Photos</button>
      <button class="tabBtn" data-tab="music">Music</button>
      <button class="tabBtn" data-tab="links">Links</button>
      <button id="logoutBtn">Logout</button>
    </div>

    <br><hr style="opacity:.2"><br>

    <div id="formArea"></div>

    <br><hr style="opacity:.2"><br>

    <div id="listArea"></div>

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  query,
  orderBy,
  doc,
  deleteDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL,
  deleteObject
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCM7bW_Ui-UxAAn3PjMONWM5aiP_DtXl3w",
  authDomain: "louarte-e66bd.firebaseapp.com",
  projectId: "louarte-e66bd",
  storageBucket: "louarte-e66bd.firebasestorage.app",
  messagingSenderId: "161343618798",
  appId: "1:161343618798:web:4b2a124f566ab49b1b3dff"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

onAuthStateChanged(auth, user => {
  if (!user) window.location.href = "login.html";
});

document.getElementById("logoutBtn").onclick = () => signOut(auth);

const formArea = document.getElementById("formArea");
const listArea = document.getElementById("listArea");

let currentTab = "artworks";

document.querySelectorAll(".tabBtn").forEach(btn => {
  btn.onclick = () => {
    currentTab = btn.dataset.tab;
    renderTab();
  };
});

function renderTab() {
  renderForm();
  loadList();
}

function renderForm() {

  // IMAGE TABS
  if (currentTab === "artworks" || currentTab === "photos") {

    formArea.innerHTML = `
      <h3>Add ${currentTab === "artworks" ? "Artwork" : "Photo"}</h3>
      <input id="title" placeholder="Title"><br><br>
      <input id="imageFile" type="file" accept="image/*"><br><br>
      <input id="order" type="number" placeholder="Order"><br><br>
      <button id="addBtn">Upload & Add</button>
    `;

    document.getElementById("addBtn").onclick = async () => {

      const title = document.getElementById("title").value.trim();
      const fileInput = document.getElementById("imageFile");
      const order = Number(document.getElementById("order").value || 9999);

      if (!fileInput.files.length) {
        alert("Select an image");
        return;
      }

      const file = fileInput.files[0];
      const filePath = `${currentTab}/${Date.now()}_${file.name}`;
      const storageRef = ref(storage, filePath);

      try {
        await uploadBytes(storageRef, file);
        const downloadURL = await getDownloadURL(storageRef);

        await addDoc(collection(db, currentTab), {
          title,
          imageUrl: downloadURL,
          storagePath: filePath,
          order
        });

        alert("Uploaded!");
        renderTab();

      } catch (err) {
        console.error(err);
        alert("Upload failed");
      }
    };

    return;
  }

  // MUSIC
  if (currentTab === "music") {
    formArea.innerHTML = `
      <h3>Add Music</h3>
      <input id="title" placeholder="Title"><br><br>
      <input id="url" placeholder="YouTube URL"><br><br>
      <input id="order" type="number" placeholder="Order"><br><br>
      <button id="addBtn">Add</button>
    `;

    document.getElementById("addBtn").onclick = async () => {
      const title = document.getElementById("title").value.trim();
      const url = document.getElementById("url").value.trim();
      const order = Number(document.getElementById("order").value || 9999);

      if (!title || !url) return alert("Fill all fields");

      await addDoc(collection(db, "music"), { title, url, order });
      renderTab();
    };

    return;
  }

  // LINKS
  if (currentTab === "links") {
    formArea.innerHTML = `
      <h3>Add Link</h3>
      <input id="icon" placeholder="Icon (emoji)"><br><br>
      <input id="title" placeholder="Title"><br><br>
      <input id="url" placeholder="URL"><br><br>
      <input id="order" type="number" placeholder="Order"><br><br>
      <button id="addBtn">Add</button>
    `;

    document.getElementById("addBtn").onclick = async () => {
      const icon = document.getElementById("icon").value.trim() || "ðŸ”—";
      const title = document.getElementById("title").value.trim();
      const url = document.getElementById("url").value.trim();
      const order = Number(document.getElementById("order").value || 9999);

      if (!title || !url) return alert("Fill all fields");

      await addDoc(collection(db, "links"), { icon, title, url, order });
      renderTab();
    };

    return;
  }
}

async function loadList() {
  listArea.innerHTML = "Loading...";

  const q = query(collection(db, currentTab), orderBy("order", "asc"));
  const snap = await getDocs(q);

  let html = `<h3>Existing ${currentTab}</h3><div style="display:flex;flex-direction:column;gap:10px;">`;

  snap.forEach(docSnap => {
    const data = docSnap.data();
    const id = docSnap.id;

    html += `
      <div style="background:rgba(255,255,255,0.05);padding:14px;border-radius:14px;">
        ${data.title ? `<input data-id="${id}" data-field="title" value="${data.title}">` : ""}
        ${data.imageUrl ? `<img src="${data.imageUrl}" style="max-width:120px;display:block;margin:8px 0;">` : ""}
        ${data.url ? `<input data-id="${id}" data-field="url" value="${data.url}">` : ""}
        ${data.icon ? `<input data-id="${id}" data-field="icon" value="${data.icon}">` : ""}
        <input data-id="${id}" data-field="order" type="number" value="${data.order || 9999}">
        <button data-action="save" data-id="${id}">Save</button>
        <button data-action="delete" data-id="${id}">Delete</button>
      </div>
    `;
  });

  html += "</div>";
  listArea.innerHTML = html;

  document.querySelectorAll("[data-action='delete']").forEach(btn => {
    btn.onclick = async () => {
      if (!confirm("Delete?")) return;

      const id = btn.dataset.id;
      const docRef = doc(db, currentTab, id);
      const docSnap = snap.docs.find(d => d.id === id);

      if (docSnap?.data().storagePath) {
        await deleteObject(ref(storage, docSnap.data().storagePath));
      }

      await deleteDoc(docRef);
      renderTab();
    };
  });

  document.querySelectorAll("[data-action='save']").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.dataset.id;
      const inputs = document.querySelectorAll(`[data-id='${id}']`);
      const updateData = {};

      inputs.forEach(i => {
        const field = i.dataset.field;
        updateData[field] = i.type === "number" ? Number(i.value) : i.value;
      });

      await updateDoc(doc(db, currentTab, id), updateData);
      alert("Updated");
      renderTab();
    };
  });
}

renderTab();
</script>

</body>
</html>